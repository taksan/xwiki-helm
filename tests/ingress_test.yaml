suite: Ingress

templates:
  - ingress.yaml

tests:
  - it: follows apiVersion networking.k8s.io/v1 for K8s >= 1.19
    capabilities:
      majorVersion: 1
      minorVersion: 20
    set:
      ingress.enabled: true
    asserts:
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1
      - isNotEmpty:
          path: spec.rules[0].http.paths[0].backend.service.name
      - isNotEmpty:
          path: spec.rules[0].http.paths[0].backend.service.port.number

  - it: follows apiVersion networking.k8s.io/v1beta1 for K8s >= 1,14, < 1.19
    capabilities:
      majorVersion: 1
      minorVersion: 14
    set:
      ingress.enabled: true
    asserts:
      - equal:
          path: apiVersion
          value: networking.k8s.io/v1beta1
      - isNotEmpty:
          path: spec.rules[0].http.paths[0].backend.serviceName
      - isNotEmpty:
          path: spec.rules[0].http.paths[0].backend.servicePort

  - it: follows apiVersion extensions/v1beta1 for K8s < 1.14
    capabilities:
      majorVersion: 1
      minorVersion: 13
    set:
      ingress.enabled: true
    asserts:
      - equal:
          path: apiVersion
          value: extensions/v1beta1
      - isNotEmpty:
          path: spec.rules[0].http.paths[0].backend.serviceName
      - isNotEmpty:
          path: spec.rules[0].http.paths[0].backend.servicePort

  - it: does not set ingress rule host by default
    set:
      ingress.enabled: true
    asserts:
      - isEmpty:
          path: spec.rules[0].host

  - it: sets ingress rule host when hostname is set in release values
    set:
      ingress:
        enabled: true
        hostName: example.com
    asserts:
      - equal:
          path: spec.rules[0].host
          value: example.com

  - it: sets tls configuration as added in release values
    set:
      ingress:
        enabled: true
        tls:
          foo: bar
          fizz: buzz
    asserts:
      - equal:
          path: spec.tls
          value:
            foo: bar
            fizz: buzz

  - it: sets annotations when included in the release values
    set:
      ingress:
        enabled: true
        annotations:
          foo: bar
          fizz: buzz
    asserts:
      - equal:
          path: metadata.annotations.foo
          value: bar
      - equal:
          path: metadata.annotations.fizz
          value: buzz
