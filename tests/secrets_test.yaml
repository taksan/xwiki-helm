suite: Secret

templates:
  - secrets.yaml

tests:
  - it: sets recommended labels according to release name
    release:
      name: example-release
    asserts:
      - equal:
          path: metadata.labels.app
          value: example-release-xwiki
      - equal:
          path: metadata.labels.release
          value: example-release

  - it: properly sets resource metadata & type
    release:
      name: release
    asserts:
      - isKind:
          of: Secret
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: release-xwiki
      - equal:
          path: metadata.labels.app
          value: release-xwiki
      - matchRegex:
          path: metadata.labels.chart
          pattern: xwiki-*
      - equal:
          path: metadata.labels.release
          value: release
      - equal:
          path: metadata.labels.heritage
          value: Helm
      - equal:
          path: type
          value: Opaque

  - it: sets MariaDB password when engine is MariaDB (pref. MariaDB > MySQL > PostgresQL)
    set:
      mariadb.auth.password: example.password-mariadb
      mariadb.enabled: true
      mysql.enabled: true
      postgresql.enabled: true
    asserts:
      - equal:
          path: data.DB_PASSWORD
          value: example.password-mariadb

  - it: sets MySQL password when engine is MySQL (pref. MariaDB > MySQL > PostgresQL)
    set:
      mysql.mysqlPassword: example.password-mysql
      mariadb.enabled: false
      mysql.enabled: true
      postgresql.enabled: true
    asserts:
      - equal:
          path: data.DB_PASSWORD
          value: example.password-mysql

  - it: sets Postgres password when engine is Postgres (pref. MariaDB > MySQL > PostgresQL)
    set:
      postgresql.postgresqlPassword: example.password-postgres
      mariadb.enabled: false
      mysql.enabled: false
      postgresql.enabled: true
    asserts:
      - equal:
          path: data.DB_PASSWORD
          value: example.password-postgres

  - it: sets external DB password when no other engine is selected
    set:
      externalDB.password: example.password-external
      mariadb.enabled: false
      mysql.enabled: false
      postgresql.enabled: false
    asserts:
      - equal:
          path: data.DB_PASSWORD
          value: example.password-external
