suite: ConfigMap

templates:
  - configmaps.yaml

tests:
  - it: does not set INDEX_HOST or INDEX_PORT is solr is disabled
    set:
      solr.enabled: false
    asserts:
      - isEmpty:
          path: data.INDEX_HOST
      - isEmpty:
          path: data.INDEX_PORT

  - it: sets the database host for MariaDB (MariaDB > MySQL > Postgres)
    set:
      mariadb.enabled: true
      mysql.enabled: true
      postgresql.enabled: true
    release:
      name: example-release
    asserts:
      - equal:
          path: data.DB_HOST
          value: example-release-mariadb

  - it: sets the database host for MySQL (MariaDB > MySQL > Postgres)
    set:
      mariadb.enabled: false
      mysql.enabled: true
      postgresql.enabled: true
    release:
      name: example-release
    asserts:
      - equal:
          path: data.DB_HOST
          value: example-release-mysql

  - it: sets the database host for Postgres (MariaDB > MySQL > Postgres)
    set:
      mariadb.enabled: false
      mysql.enabled: false
      postgresql.enabled: true
    release:
      name: example-release
    asserts:
      - equal:
          path: data.DB_HOST
          value: example-release-postgresql

  - it: sets the database host for external databases
    set:
      mariadb.enabled: false
      mysql.enabled: false
      postgresql.enabled: false
      externalDB.host: example.host.svc
    asserts:
      - equal:
          path: data.DB_HOST
          value: example.host.svc

  - it: sets MariaDB values if present (MariaDB > MySQL > Postgres)
    set:
      mysql.enabled: true
      postgresql.enabled: true
      mariadb:
        enabled: true
        auth:
          username: mariadb-user
          database: mariadb-database
    asserts:
      - equal:
          path: data.DB_USER
          value: mariadb-user
      - equal:
          path: data.DB_DATABASE
          value: mariadb-database

  - it: sets MySQL values if present (MariaDB > MySQL > Postgres)
    set:
      mariadb.enabled: false
      postgresql.enabled: true
      mysql:
        enabled: true
        mysqlUser: mysql-user
        mysqlDatabase: mysql-database
    asserts:
      - equal:
          path: data.DB_USER
          value: mysql-user
      - equal:
          path: data.DB_DATABASE
          value: mysql-database

  - it: sets Postgres values if present (MariaDB > MySQL > Postgres)
    set:
      mariadb.enabled: false
      mysql.enabled: false
      postgresql:
        enabled: true
        postgresqlUsername: postgres-user
        postgresqlDatabase: postgres-database
    asserts:
      - equal:
          path: data.DB_USER
          value: postgres-user
      - equal:
          path: data.DB_DATABASE
          value: postgres-database

  - it: sets external DB values when using no other engine
    set:
      mariadb.enabled: false
      mysql.enabled: false
      postgresql.enabled: false
      externalDB:
        user: extdb-user
        database: extdb-database
    asserts:
      - equal:
          path: data.DB_USER
          value: extdb-user
      - equal:
          path: data.DB_DATABASE
          value: extdb-database
